<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Team Names to Team1-Team20</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .update-container {
            max-width: 600px;
        }
        .update-log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-success { color: #4ecca3; }
        .log-error { color: #ff6b6b; }
        .log-info { color: #00d9ff; }
        .log-warning { color: #ffd700; }
    </style>
</head>
<body>
    <div class="container update-container">
        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 30px; backdrop-filter: blur(10px);">
            <h1>üîÑ Update Team Names</h1>
            <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;">
                This tool will update all team names from old format to Team1-Team20
            </p>
            
            <button id="updateBtn" class="btn-primary" style="width: 100%; padding: 14px; margin-bottom: 20px; font-size: 16px;">
                üöÄ Start Update Now
            </button>

            <div id="updateLog" class="update-log">
                <div class="log-info">Logs will appear here...</div>
            </div>

            <button id="backBtn" class="btn-secondary" style="width: 100%; padding: 14px; margin-top: 20px;">
                ‚Üê Back to Admin
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCio8kkBavGfdUECfFadDGRvhLyO3DlBwI",
            authDomain: "freefire-thinkbotz.firebaseapp.com",
            projectId: "freefire-thinkbotz",
            storageBucket: "freefire-thinkbotz.firebasestorage.app",
            messagingSenderId: "513327286952",
            appId: "1:513327286952:web:e8ef8fca42f09d2b5c509d",
            measurementId: "G-K0MWN4P9PF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const logDiv = document.getElementById('updateLog');
        const updateBtn = document.getElementById('updateBtn');
        const backBtn = document.getElementById('backBtn');

        // Team name mapping - OLD NAMES to NEW NAMES
        const teamNameMap = {
            'Team Alpha': 'Team1',
            'Team Bravo': 'Team2',
            'Team Charlie': 'Team3',
            'Team Delta': 'Team4',
            'Team Echo': 'Team5',
            'Team Foxtrot': 'Team6',
            'Team Golf': 'Team7',
            'Team Hotel': 'Team8',
            'Team India': 'Team9',
            'Team Juliett': 'Team10',
            'Team Kilo': 'Team11',
            'Team Lima': 'Team12',
            'Team Mike': 'Team13',
            'Team November': 'Team14',
            'Team Oscar': 'Team15',
            'Team Papa': 'Team16',
            'Team Quebec': 'Team17',
            'Team Romeo': 'Team18',
            'Team Sierra': 'Team19',
            'Team Tango': 'Team20'
        };

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function performUpdate() {
            try {
                updateBtn.disabled = true;
                logDiv.innerHTML = '';

                addLog('üîç Starting team name update...', 'info');
                
                // Check if user is authenticated
                const user = auth.currentUser;
                if (!user) {
                    addLog('‚ùå Not authenticated! Need to login first.', 'error');
                    addLog('Attempting to login as admin...', 'warning');
                    
                    // Try to sign in as admin
                    try {
                        await signInWithEmailAndPassword(auth, 'admin@thinkbotz.com', 'Asdf4321');
                        addLog('‚úì Admin login successful!', 'success');
                    } catch (loginError) {
                        addLog(`‚ùå Login failed: ${loginError.message}`, 'error');
                        addLog('Please make sure you\'re logged in as admin first', 'error');
                        updateBtn.disabled = false;
                        return;
                    }
                }
                
                addLog(`‚úì Authenticated as: ${auth.currentUser.email}`, 'success');
                addLog('Fetching all teams from database...', 'info');
                
                // Get all teams
                const querySnapshot = await getDocs(collection(db, 'teams'));
                addLog(`‚úì Found ${querySnapshot.size} teams in database`, 'success');
                addLog('', 'info');

                const batch = writeBatch(db);
                let updateCount = 0;
                let skipCount = 0;

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const oldName = data.name;
                    const newName = teamNameMap[oldName];

                    if (newName) {
                        if (oldName !== newName) {
                            addLog(`üìù ${docSnap.id}: "${oldName}" ‚Üí "${newName}"`, 'warning');
                            batch.update(doc(db, 'teams', docSnap.id), { name: newName });
                            updateCount++;
                        } else {
                            addLog(`‚úì ${docSnap.id}: "${oldName}" (already correct)`, 'success');
                            skipCount++;
                        }
                    } else {
                        // Check if already in new format
                        if (oldName.match(/^Team\d+$/)) {
                            addLog(`‚úì ${docSnap.id}: "${oldName}" (already new format)`, 'success');
                            skipCount++;
                        } else {
                            addLog(`‚ùå ${docSnap.id}: "${oldName}" - NO MAPPING FOUND`, 'error');
                        }
                    }
                });

                addLog('', 'info');
                addLog(`Summary: ${updateCount} teams need update, ${skipCount} already correct`, 'warning');
                
                if (updateCount > 0) {
                    addLog('', 'info');
                    addLog('üì§ Committing updates to Firestore...', 'info');
                    await batch.commit();
                    addLog(`‚úÖ SUCCESS! Updated ${updateCount} team names!`, 'success');
                    addLog('', 'info');
                    addLog('üí° Refresh the admin panel to see the changes', 'success');
                } else {
                    addLog('‚ö†Ô∏è No teams needed updating', 'warning');
                }

            } catch (error) {
                addLog(`‚ùå ERROR: ${error.message}`, 'error');
                addLog(`Code: ${error.code}`, 'error');
                console.error('Update error:', error);
            } finally {
                updateBtn.disabled = false;
            }
        }

        updateBtn.addEventListener('click', performUpdate);
        backBtn.addEventListener('click', () => {
            window.location.href = 'admin.html';
        });

        // Check auth on load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                addLog(`‚úì Logged in as: ${user.email}`, 'success');
            } else {
                addLog('‚ö†Ô∏è Not logged in. Click update to login automatically.', 'warning');
            }
        });
    </script>
</body>
</html>
